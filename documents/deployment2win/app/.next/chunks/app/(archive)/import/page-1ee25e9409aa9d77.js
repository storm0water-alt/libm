(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8068],{3399:(e,s,t)=>{Promise.resolve().then(t.bind(t,2261))},2261:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>er});var a=t(5155),r=t(2115),l=t(696),n=t(6046),i=t(4085),d=t(5007),c=t(9677),o=t(8629),x=t(1027),u=t(9602);function m(e){let{className:s,orientation:t="horizontal",...r}=e;return(0,a.jsx)(o.bL,{"data-slot":"tabs","data-orientation":t,orientation:t,className:(0,u.cn)("group/tabs flex gap-2 data-[orientation=horizontal]:flex-col",s),...r})}let h=(0,x.F)("rounded-lg p-[3px] group-data-[orientation=horizontal]/tabs:h-9 data-[variant=line]:rounded-none group/tabs-list text-muted-foreground inline-flex w-fit items-center justify-center group-data-[orientation=vertical]/tabs:h-fit group-data-[orientation=vertical]/tabs:flex-col",{variants:{variant:{default:"bg-muted",line:"gap-1 bg-transparent"}},defaultVariants:{variant:"default"}});function p(e){let{className:s,variant:t="default",...r}=e;return(0,a.jsx)(o.B8,{"data-slot":"tabs-list","data-variant":t,className:(0,u.cn)(h({variant:t}),s),...r})}function v(e){let{className:s,...t}=e;return(0,a.jsx)(o.l9,{"data-slot":"tabs-trigger",className:(0,u.cn)("focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring text-foreground/60 hover:text-foreground dark:text-muted-foreground dark:hover:text-foreground relative inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-all group-data-[orientation=vertical]/tabs:w-full group-data-[orientation=vertical]/tabs:justify-start focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 group-data-[variant=default]/tabs-list:data-[state=active]:shadow-sm group-data-[variant=line]/tabs-list:data-[state=active]:shadow-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4","group-data-[variant=line]/tabs-list:bg-transparent group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:border-transparent dark:group-data-[variant=line]/tabs-list:data-[state=active]:bg-transparent","data-[state=active]:bg-background dark:data-[state=active]:text-foreground dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 data-[state=active]:text-foreground","after:bg-foreground after:absolute after:opacity-0 after:transition-opacity group-data-[orientation=horizontal]/tabs:after:inset-x-0 group-data-[orientation=horizontal]/tabs:after:bottom-[-5px] group-data-[orientation=horizontal]/tabs:after:h-0.5 group-data-[orientation=vertical]/tabs:after:inset-y-0 group-data-[orientation=vertical]/tabs:after:-right-1 group-data-[orientation=vertical]/tabs:after:w-0.5 group-data-[variant=line]/tabs-list:data-[state=active]:after:opacity-100",s),...t})}function g(e){let{className:s,...t}=e;return(0,a.jsx)(o.UC,{"data-slot":"tabs-content",className:(0,u.cn)("flex-1 outline-none",s),...t})}var f=t(8684),j=t(9688),b=t(4505),N=t(4081),y=t(1594),w=t(2336),A=t(5785),k=t(2079),S=t(7581),C=t(767),z=t(814),F=t(5828);let E=(0,F.createServerReference)("40b314d67d2e152606affbd598b460918efdd92564",F.callServer,void 0,F.findSourceMapURL,"scanFolderAction");var V=t(6507),_=t(6967),R=t(6308),I=t(6659);function B(e){let{onPathSelected:s,disabled:t=!1}=e,[l,n]=(0,r.useState)("/"),[d,c]=(0,r.useState)([]),[o,x]=(0,r.useState)(!1),[u,m]=(0,r.useState)("/"),h=async e=>{x(!0);try{let s=await fetch("/api/browse?path=".concat(encodeURIComponent(e)));if(!s.ok)throw Error("Failed to browse: ".concat(s.status));let t=await s.json();if(!t.success||!t.data)throw Error(t.error||"Failed to browse directory");n(t.data.currentPath),c(t.data.items),m(t.data.currentPath)}catch(e){console.error("Browse error:",e),z.o.error(e instanceof Error?e.message:"Failed to browse directory")}finally{x(!1)}};(0,r.useEffect)(()=>{h("/")},[]);let p=e=>{e.isDirectory&&h(e.path)},v=e=>{h(e)};return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(A.J,{children:"快速导航"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:[{path:"/",label:"Root (/)"},{path:"/Volumes",label:"Volumes (macOS external drives)"},{path:"/mnt",label:"Mount (Linux external drives)"},{path:"/home",label:"Home (Linux)"},{path:"/Users",label:"Users (macOS)"}].map(e=>(0,a.jsxs)(i.$,{type:"button",variant:"outline",size:"sm",onClick:()=>v(e.path),disabled:t||o,children:[(0,a.jsx)(S.A,{className:"h-3 w-3 mr-1"}),e.label]},e.path))})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(A.J,{htmlFor:"path-input",children:"当前路径"}),(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault(),u.trim()&&h(u.trim())},className:"flex gap-2",children:[(0,a.jsx)(w.p,{id:"path-input",type:"text",value:u,onChange:e=>m(e.target.value),disabled:t||o,className:"font-mono text-sm"}),(0,a.jsx)(i.$,{type:"submit",disabled:t||o,variant:"outline",children:"转到"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-sm overflow-x-auto",children:[(0,a.jsx)(i.$,{type:"button",variant:"ghost",size:"sm",className:"h-6 px-2",onClick:()=>v("/"),disabled:t||o,children:(0,a.jsx)(V.A,{className:"h-3 w-3"})}),l.split("/").filter(Boolean).map((e,s,r)=>{let l="/"+r.slice(0,s+1).join("/"),n=s===r.length-1;return(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(_.A,{className:"h-3 w-3 text-muted-foreground"}),(0,a.jsx)(i.$,{type:"button",variant:n?"default":"ghost",size:"sm",className:"h-6 px-2",onClick:()=>!n&&h(l),disabled:t||o,children:e})]},l)})]}),(0,a.jsx)("div",{className:"border rounded-md",children:(0,a.jsx)("div",{className:"max-h-[400px] overflow-y-auto",children:(0,a.jsxs)(k.XI,{children:[(0,a.jsx)(k.A0,{children:(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nd,{className:"w-[40px]"}),(0,a.jsx)(k.nd,{children:"名称"}),(0,a.jsx)(k.nd,{className:"w-[100px]",children:"类型"}),(0,a.jsx)(k.nd,{className:"w-[80px]",children:"大小"})]})}),(0,a.jsx)(k.BF,{children:o?(0,a.jsx)(k.Hj,{children:(0,a.jsx)(k.nA,{colSpan:4,className:"text-center py-8 text-muted-foreground",children:"加载中..."})}):0===d.length?(0,a.jsx)(k.Hj,{children:(0,a.jsx)(k.nA,{colSpan:4,className:"text-center py-8 text-muted-foreground",children:"此目录为空"})}):d.map(e=>{var s;return(0,a.jsxs)(k.Hj,{className:"cursor-pointer hover:bg-muted/50 ".concat(e.isDirectory?"":"opacity-50"),onClick:()=>p(e),children:[(0,a.jsx)(k.nA,{className:"w-[40px]",children:e.isDirectory?(0,a.jsx)(R.A,{className:"h-4 w-4 text-blue-500"}):(0,a.jsx)(I.A,{className:"h-4 w-4 text-muted-foreground"})}),(0,a.jsx)(k.nA,{children:(0,a.jsx)("span",{className:"font-medium",children:e.name})}),(0,a.jsx)(k.nA,{className:"text-muted-foreground",children:e.isDirectory?"目录":"文件"}),(0,a.jsx)(k.nA,{className:"text-muted-foreground",children:e.isDirectory?"-":(s=e.size)<1024?s+" B":s<1048576?(s/1024).toFixed(1)+" KB":(s/1048576).toFixed(1)+" MB"})]},e.path)})})]})})}),(0,a.jsx)("div",{className:"flex gap-2",children:(0,a.jsxs)(i.$,{onClick:()=>{s(l)},disabled:t||o,className:"flex-1",children:[(0,a.jsx)(R.A,{className:"h-4 w-4 mr-2"}),"选择此目录"]})})]})}function P(e){let{onFilesSelected:s,disabled:t=!1,selectedFiles:l=[]}=e,[n,c]=(0,r.useState)(l),[o,x]=(0,r.useState)(!1),[u,h]=(0,r.useState)("local"),j=async e=>{x(!0);try{let t=await E(e);if(!t.success){z.o.error(t.error||"扫描文件夹失败");return}let a=t.data||[];if(0===a.length){z.o.warning("文件夹中没有找到 PDF 文件");return}c(a),s(a),z.o.success("找到 ".concat(a.length," 个 PDF 文件"))}catch(e){console.error("Scan folder error:",e),z.o.error(e instanceof Error?e.message:"扫描文件夹失败")}finally{x(!1)}},b=async e=>{let t=e.target.files;if(t&&0!==t.length)try{let e=[];for(let s=0;s<t.length;s++){let a=t[s];a.name.toLowerCase().endsWith(".pdf")&&e.push({name:a.name,path:a.webkitRelativePath||a.name,size:a.size,file:a})}c(e),s(e),z.o.success("已选择 ".concat(e.length," 个文件"))}catch(e){console.error("File select error:",e),z.o.error("文件选择失败")}},y=e=>{let t=n.filter((s,t)=>t!==e);c(t),s(t)},F=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB";return(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(m,{value:u,onValueChange:e=>h(e),className:"w-full",children:[(0,a.jsxs)(p,{className:"grid w-full grid-cols-2",children:[(0,a.jsxs)(v,{value:"local",children:[(0,a.jsx)(S.A,{className:"h-4 w-4 mr-2"}),"本地复制"]}),(0,a.jsxs)(v,{value:"upload",children:[(0,a.jsx)(f.A,{className:"h-4 w-4 mr-2"}),"浏览器上传"]})]}),(0,a.jsxs)(g,{value:"local",className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(A.J,{children:"浏览服务器文件系统"}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["选择移动硬盘或源文件夹，系统将使用 ",(0,a.jsx)("code",{children:"cp"})," 命令直接复制文件（速度快，支持大文件）"]})]}),(0,a.jsx)(B,{onPathSelected:j,disabled:t||o})]}),(0,a.jsx)(g,{value:"upload",className:"space-y-4",children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(A.J,{htmlFor:"file-upload",children:"选择文件夹"}),(0,a.jsx)(w.p,{id:"file-upload",type:"file",webkitdirectory:"",directory:"",multiple:!0,accept:".pdf",onChange:b,disabled:t,className:"cursor-pointer"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"适用于：远程访问或文件在个人电脑上。将通过浏览器上传文件（受网络速度影响）"})]})})]}),n.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)(A.J,{children:["待入库文件 (",n.length,")"]}),(0,a.jsx)(i.$,{type:"button",variant:"outline",size:"sm",onClick:()=>{c([]),s([])},disabled:t,children:"清空列表"})]}),(0,a.jsx)("div",{className:"border rounded-md max-h-[400px] overflow-y-auto",children:(0,a.jsxs)(k.XI,{children:[(0,a.jsx)(k.A0,{children:(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nd,{className:"w-[50px]",children:"#"}),(0,a.jsx)(k.nd,{children:"文件名"}),(0,a.jsx)(k.nd,{className:"w-[120px]",children:"大小"}),(0,a.jsx)(k.nd,{className:"w-[80px]",children:"操作"})]})}),(0,a.jsx)(k.BF,{children:n.map((e,s)=>(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nA,{className:"text-muted-foreground",children:s+1}),(0,a.jsx)(k.nA,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(N.A,{className:"h-4 w-4 text-red-500"}),(0,a.jsx)("span",{className:"font-medium",children:e.name})]})}),(0,a.jsx)(k.nA,{children:F(e.size)}),(0,a.jsx)(k.nA,{children:(0,a.jsx)(i.$,{type:"button",variant:"ghost",size:"sm",onClick:()=>y(s),disabled:t,children:(0,a.jsx)(C.A,{className:"h-4 w-4"})})})]},s))})]})}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["总计: ",n.length," 个文件，总大小: ",F(n.reduce((e,s)=>e+s.size,0))]})]})]})})})}var D=t(2263);function $(e){let{className:s,value:t,...r}=e;return(0,a.jsx)(D.bL,{"data-slot":"progress",className:(0,u.cn)("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",s),...r,children:(0,a.jsx)(D.C1,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:"translateX(-".concat(100-(t||0),"%)")}})})}var Z=t(9286),L=t(6889),M=t(6336),W=t(5340),H=t(7478);let U=(0,F.createServerReference)("00ac4826793d59c020373288f13c00181c1b8576c2",F.callServer,void 0,F.findSourceMapURL,"getActiveImportsAction"),T=(0,F.createServerReference)("404390b73cd35dd7b250596b4aa51d8a7571f1ad2f",F.callServer,void 0,F.findSourceMapURL,"cancelImportAction");function J(e){let{autoRefresh:s=!0,refreshInterval:t=2e3,onComplete:l}=e,[n,c]=(0,r.useState)([]),[o,x]=(0,r.useState)(!0),u=async()=>{try{let e=await U();if(e.success&&e.data){let s=e.data,t=new Set(n.map(e=>e.id));s.forEach(e=>{t.has(e.id)&&"completed"===e.status&&(null==l||l(e))}),c(s)}}catch(e){console.error("Failed to fetch progress:",e)}finally{x(!1)}};(0,r.useEffect)(()=>{if(u(),s){let e=setInterval(u,t);return()=>clearInterval(e)}},[s,t]);let m=async e=>{try{let s=await T(e);s.success?(z.o.success("入库任务已取消"),await u()):z.o.error(s.error||"取消失败")}catch(e){z.o.error("取消失败")}},h=e=>{switch(e){case"pending":return(0,a.jsx)(L.A,{className:"h-4 w-4 text-gray-500"});case"processing":return(0,a.jsx)(b.A,{className:"h-4 w-4 text-blue-500 animate-spin"});case"completed":return(0,a.jsx)(M.A,{className:"h-4 w-4 text-green-500"});case"failed":return(0,a.jsx)(W.A,{className:"h-4 w-4 text-red-500"});case"cancelled":return(0,a.jsx)(W.A,{className:"h-4 w-4 text-gray-500"});case"skipped":return(0,a.jsx)(H.A,{className:"h-4 w-4 text-yellow-500"})}},p=e=>{switch(e){case"pending":return(0,a.jsx)(Z.E,{variant:"secondary",children:"等待中"});case"processing":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-blue-500",children:"处理中"});case"completed":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-green-500",children:"已完成"});case"failed":return(0,a.jsx)(Z.E,{variant:"destructive",children:"失败"});case"cancelled":return(0,a.jsx)(Z.E,{variant:"secondary",children:"已取消"});case"skipped":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-yellow-500",children:"已跳过"})}};return o?(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)(b.A,{className:"h-8 w-8 animate-spin text-muted-foreground"})})})}):0===n.length?(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"暂无进行中的入库任务"})})}):(0,a.jsxs)(d.Zp,{children:[(0,a.jsx)(d.aR,{children:(0,a.jsxs)(d.ZB,{children:["入库进度 (",n.length,")"]})}),(0,a.jsx)(d.Wu,{children:(0,a.jsx)("div",{className:"space-y-4",children:n.map(e=>(0,a.jsxs)("div",{className:"border rounded-lg p-4 space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[h(e.status),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:e.fileName}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["操作人: ",e.operator," • ",new Date(e.createdAt).toLocaleString()]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[p(e.status),("pending"===e.status||"processing"===e.status)&&(0,a.jsx)(i.$,{variant:"ghost",size:"sm",onClick:()=>m(e.id),children:(0,a.jsx)(C.A,{className:"h-4 w-4"})})]})]}),"processing"===e.status&&(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"处理进度"}),(0,a.jsxs)("span",{className:"font-medium",children:[e.progress,"%"]})]}),(0,a.jsx)($,{value:e.progress,className:"h-2"})]}),"skipped"===e.status&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm text-yellow-600 bg-yellow-50 p-2 rounded",children:[(0,a.jsx)(H.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{children:"档号已存在，跳过此文件"})]}),"failed"===e.status&&e.error&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm text-red-600 bg-red-50 p-2 rounded",children:[(0,a.jsx)(y.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{children:e.error})]})]},e.id))})})]})}var O=t(745);let X=(0,F.createServerReference)("40015b0f485a9be2c61b8da054fe0fa3ff1ed35d85",F.callServer,void 0,F.findSourceMapURL,"queryImportHistoryAction");var q=t(1453);function K(e){let{autoRefresh:s=!1,refreshInterval:t=1e4}=e,[l,n]=(0,r.useState)([]),[i,c]=(0,r.useState)(0),[o,x]=(0,r.useState)(0),[u,m]=(0,r.useState)(1),[h]=(0,r.useState)(20),[p,v]=(0,r.useState)(!0),[g,f]=(0,r.useState)("all"),[j,N]=(0,r.useState)(""),y=async()=>{v(!0);try{let e=await X({page:u,pageSize:h,status:"all"!==g?g:void 0,operator:j||void 0});e.success&&e.data&&(n(e.data.items),c(e.data.total),x(e.data.totalPages))}catch(e){console.error("Failed to fetch history:",e)}finally{v(!1)}};(0,r.useEffect)(()=>{y()},[u,g,j]),(0,r.useEffect)(()=>{if(s){let e=setInterval(y,t);return()=>clearInterval(e)}},[s,t,u,g,j]);let A=e=>{switch(e){case"pending":return(0,a.jsx)(Z.E,{variant:"secondary",children:"等待中"});case"processing":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-blue-500",children:"处理中"});case"completed":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-green-500",children:"已完成"});case"failed":return(0,a.jsx)(Z.E,{variant:"destructive",children:"失败"});case"cancelled":return(0,a.jsx)(Z.E,{variant:"outline",children:"已取消"});case"skipped":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-yellow-500",children:"已跳过"})}},S=e=>new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return(0,a.jsxs)(d.Zp,{children:[(0,a.jsx)(d.aR,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)(d.ZB,{children:"入库历史"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(w.p,{placeholder:"操作人",value:j,onChange:e=>{N(e.target.value),m(1)},className:"w-40"}),(0,a.jsxs)(O.l6,{value:g,onValueChange:e=>{f(e),m(1)},children:[(0,a.jsx)(O.bq,{className:"w-32",children:(0,a.jsx)(O.yv,{placeholder:"状态"})}),(0,a.jsxs)(O.gC,{children:[(0,a.jsx)(O.eb,{value:"all",children:"全部"}),(0,a.jsx)(O.eb,{value:"pending",children:"等待中"}),(0,a.jsx)(O.eb,{value:"processing",children:"处理中"}),(0,a.jsx)(O.eb,{value:"completed",children:"已完成"}),(0,a.jsx)(O.eb,{value:"failed",children:"失败"}),(0,a.jsx)(O.eb,{value:"cancelled",children:"已取消"}),(0,a.jsx)(O.eb,{value:"skipped",children:"已跳过"})]})]})]})]})}),(0,a.jsx)(d.Wu,{children:(0,a.jsx)("div",{className:"space-y-4",children:p?(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)(b.A,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):0===l.length?(0,a.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"暂无入库记录"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"border rounded-md",children:(0,a.jsxs)(k.XI,{children:[(0,a.jsx)(k.A0,{children:(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nd,{children:"文件名"}),(0,a.jsx)(k.nd,{className:"w-[100px]",children:"状态"}),(0,a.jsx)(k.nd,{className:"w-[100px]",children:"进度"}),(0,a.jsx)(k.nd,{children:"操作人"}),(0,a.jsx)(k.nd,{children:"创建时间"})]})}),(0,a.jsx)(k.BF,{children:l.map(e=>(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nA,{className:"font-medium",children:e.fileName}),(0,a.jsx)(k.nA,{children:A(e.status)}),(0,a.jsxs)(k.nA,{children:[e.progress,"%"]}),(0,a.jsx)(k.nA,{children:e.operator}),(0,a.jsx)(k.nA,{children:S(e.createdAt)})]},e.id))})]})}),(0,a.jsx)(q.d,{currentPage:u,totalPages:o,total:i,pageSize:h,onPageChange:e=>{e>=1&&e<=o&&m(e)}})]})})})]})}function Q(e){var s,t,l,n,c,o,x,u,m,h,p;let{onFileSelected:v,onValidationComplete:g,disabled:f=!1}=e,[N,k]=(0,r.useState)(null),[S,F]=(0,r.useState)("idle"),[E,V]=(0,r.useState)(!1),[R,I]=(0,r.useState)(null),[B,P]=(0,r.useState)(null),[D,$]=(0,r.useState)(0),L=async e=>{var s;let t=null===(s=e.target.files)||void 0===s?void 0:s[0];if(t){if(!t.name.endsWith(".csv")){z.o.error("请选择 CSV 文件");return}k(t),F("format"),I(null),P(null),V(!1),v(t),await W(t)}},W=async e=>{V(!0);try{let s=new FormData;s.append("file",e),s.append("step","format");let t=await fetch("/api/import/csv/validate",{method:"POST",body:s}),a=await t.json();a.success?(I(a.data),F("format"),z.o.success("格式校验通过：共 ".concat(a.data.totalRecords," 条记录"))):(I(a.data),F("format"),z.o.error(a.error||"格式校验失败"))}catch(e){console.error("Format validation error:",e),z.o.error("格式校验失败")}finally{V(!1)}},H=async()=>{if(R&&N){V(!0),P(null);try{let e=new FormData;e.append("file",N),e.append("step","exist"),e.append("archiveNos",JSON.stringify(R.archiveNos));let s=await fetch("/api/import/csv/validate",{method:"POST",body:e});if(!s.ok)throw Error("HTTP ".concat(s.status,": ").concat(s.statusText));let t=await s.json();t.success?(P(t.existCheck),F("ready"),z.o.success("档号校验通过，可以开始导入"),g(R.archiveNos)):(P(t.existCheck),F("exist"),z.o.error(t.error||"档号校验失败"))}catch(s){console.error("Exist validation error:",s);let e=s instanceof Error?s.message:"档号校验失败";P({total:R.archiveNos.length,existCount:0,notExistCount:R.archiveNos.length,notExistArchiveNos:R.archiveNos}),F("exist"),z.o.error("档号校验失败: ".concat(e))}finally{V(!1)}}},U=()=>{k(null),F("idle"),I(null),P(null),V(!1),$(e=>e+1),v(null),null==g||g([])};return(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsxs)("div",{className:"space-y-4",children:[N&&(0,a.jsxs)("div",{className:"flex items-center gap-2 pb-4 border-b",children:[(0,a.jsx)(G,{number:1,label:"格式校验",status:"format"===S?E?"loading":0===((null==R?void 0:null===(s=R.emptyArchiveNos)||void 0===s?void 0:s.length)||0)&&0===((null==R?void 0:null===(t=R.duplicateArchiveNos)||void 0===t?void 0:t.length)||0)?"success":"error":"exist"===S||"ready"===S?"success":"pending"}),(0,a.jsx)(_.A,{className:"h-4 w-4 text-gray-400"}),(0,a.jsx)(G,{number:2,label:"档号校验",status:"exist"===S?E?"loading":(null==B?void 0:B.notExistCount)===0?"success":"error":"ready"===S?"success":"pending"}),(0,a.jsx)(_.A,{className:"h-4 w-4 text-gray-400"}),(0,a.jsx)(G,{number:3,label:"导入",status:"ready"===S?"success":"pending"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(A.J,{htmlFor:"csv-upload",children:"选择 CSV 文件"}),(0,a.jsx)(w.p,{id:"csv-upload",type:"file",accept:".csv",onChange:L,disabled:f,className:"cursor-pointer"},D),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"上传档案信息表（CSV 格式），系统将自动进行格式校验和档号校验"})]}),N&&(0,a.jsx)("div",{className:"border rounded-lg p-4 bg-muted/50",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(j.A,{className:"h-8 w-8 text-green-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:N.name}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["大小: ",(p=N.size)<1024?p+" B":p<1048576?(p/1024).toFixed(1)+" KB":(p/1048576).toFixed(1)+" MB"]})]})]}),(0,a.jsx)(i.$,{variant:"ghost",size:"sm",onClick:U,disabled:f,children:(0,a.jsx)(C.A,{className:"h-4 w-4"})})]})}),"format"===S&&R&&(0,a.jsx)(Y,{title:"格式校验结果",success:0===((null===(l=R.emptyArchiveNos)||void 0===l?void 0:l.length)||0)&&0===((null===(n=R.duplicateArchiveNos)||void 0===n?void 0:n.length)||0),children:(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsx)("span",{className:"font-medium",children:"总记录数："}),R.totalRecords," 条"]}),(null===(c=R.emptyArchiveNos)||void 0===c?void 0:c.length)>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-sm font-medium text-red-600 mb-2",children:["❌ 空白档号 (",R.emptyArchiveNos.length," 个)"]}),(0,a.jsx)("div",{className:"max-h-32 overflow-y-auto bg-red-50 p-2 rounded text-xs",children:R.emptyArchiveNos.map(e=>(0,a.jsxs)(Z.E,{variant:"destructive",className:"m-1",children:["第 ",e.row," 行"]},e.index))})]}),(null===(o=R.duplicateArchiveNos)||void 0===o?void 0:o.length)>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-sm font-medium text-red-600 mb-2",children:["❌ 重复档号 (",R.duplicateArchiveNos.length," 个)"]}),(0,a.jsx)("div",{className:"max-h-32 overflow-y-auto bg-red-50 p-2 rounded text-xs space-y-1",children:R.duplicateArchiveNos.map(e=>{let{archiveNo:s,rows:t}=e;return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(Z.E,{variant:"destructive",children:s}),(0,a.jsxs)("span",{className:"text-gray-600",children:["第 ",t.join(", ")," 行"]})]},s)})})]}),0===((null===(x=R.emptyArchiveNos)||void 0===x?void 0:x.length)||0)&&0===((null===(u=R.duplicateArchiveNos)||void 0===u?void 0:u.length)||0)&&(0,a.jsx)(i.$,{onClick:H,disabled:E,className:"w-full",children:E?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.A,{className:"h-4 w-4 mr-2 animate-spin"}),"校验中..."]}):(0,a.jsxs)(a.Fragment,{children:["继续档号校验 ",(0,a.jsx)(_.A,{className:"h-4 w-4 ml-2"})]})}),((null===(m=R.emptyArchiveNos)||void 0===m?void 0:m.length)>0||(null===(h=R.duplicateArchiveNos)||void 0===h?void 0:h.length)>0)&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"border rounded-lg p-3 bg-red-50 dark:bg-red-950/20",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(y.A,{className:"h-4 w-4 text-red-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{className:"text-sm text-red-900 dark:text-red-100",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"格式校验失败"}),(0,a.jsx)("div",{className:"text-xs",children:"CSV 文件存在格式问题，请修正后重新上传文件。"})]})]})}),(0,a.jsx)("div",{className:"border rounded-lg p-3 bg-blue-50 dark:bg-blue-950/20",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(y.A,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{className:"text-sm text-blue-900 dark:text-blue-100",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"修正方法"}),(0,a.jsxs)("ul",{className:"list-disc list-inside space-y-0.5 text-xs",children:[(0,a.jsx)("li",{children:"确保所有行都有档号，不能为空"}),(0,a.jsx)("li",{children:"确保档号唯一，不能重复"}),(0,a.jsx)("li",{children:"修改 CSV 文件后，请重新选择文件上传"})]})]})]})}),(0,a.jsx)("div",{className:"flex gap-2",children:(0,a.jsx)(i.$,{onClick:U,variant:"outline",className:"flex-1",children:"重新选择文件"})})]})]})}),"exist"===S&&E&&!B&&(0,a.jsx)("div",{className:"border rounded-lg p-8 bg-gray-50 dark:bg-gray-900",children:(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center space-y-4",children:[(0,a.jsx)(b.A,{className:"h-8 w-8 animate-spin text-blue-600"}),(0,a.jsx)("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"正在校验档号，请稍候..."})]})}),"exist"===S&&B&&(0,a.jsx)(Y,{title:"档号校验结果",success:0===B.notExistCount,children:(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-4 text-center",children:[(0,a.jsxs)("div",{className:"bg-blue-50 p-3 rounded",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:B.total}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"总档号数"})]}),(0,a.jsxs)("div",{className:"bg-green-50 p-3 rounded",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:B.existCount}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"已存在"})]}),(0,a.jsxs)("div",{className:"bg-red-50 p-3 rounded",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:B.notExistCount}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:"不存在"})]})]}),B.notExistArchiveNos.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm font-medium text-red-600 mb-2",children:"以下档号在数据库中不存在："}),(0,a.jsx)("div",{className:"max-h-40 overflow-y-auto bg-red-50 p-2 rounded text-xs",children:B.notExistArchiveNos.map(e=>(0,a.jsx)(Z.E,{variant:"destructive",className:"m-1",children:e},e))})]}),0===B.notExistCount&&(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsx)(M.A,{className:"h-12 w-12 text-green-600 mx-auto mb-2"}),(0,a.jsx)("div",{className:"font-medium text-green-600",children:"校验通过"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 mt-1",children:["所有 ",B.total," 个档号都存在于数据库中"]})]}),B.notExistCount>0&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"border rounded-lg p-3 bg-red-50 dark:bg-red-950/20",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(y.A,{className:"h-4 w-4 text-red-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{className:"text-sm text-red-900 dark:text-red-100",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"校验失败"}),(0,a.jsxs)("div",{className:"text-xs",children:["有 ",B.notExistCount," 个档号在数据库中不存在，无法继续导入。"]})]})]})}),(0,a.jsx)("div",{className:"border rounded-lg p-3 bg-blue-50 dark:bg-blue-950/20",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(y.A,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{className:"text-sm text-blue-900 dark:text-blue-100",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"解决方法"}),(0,a.jsxs)("ul",{className:"list-disc list-inside space-y-0.5 text-xs",children:[(0,a.jsx)("li",{children:'先通过"PDF入库"上传对应的档案文件'}),(0,a.jsx)("li",{children:"或者修改 CSV 文件，去掉不存在的档号"})]})]})]})}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(i.$,{onClick:()=>{H()},variant:"outline",className:"flex-1",children:"重新校验"}),(0,a.jsx)(i.$,{onClick:U,variant:"ghost",className:"flex-1",children:"取消导入"})]})]})]})}),"ready"===S&&(0,a.jsx)("div",{className:"border rounded-lg p-6 bg-green-50 dark:bg-green-950/20",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(M.A,{className:"h-8 w-8 text-green-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-green-900 dark:text-green-100",children:"校验完成，可以开始导入"}),(0,a.jsxs)("div",{className:"text-sm text-green-700 dark:text-green-300",children:[null==R?void 0:R.totalRecords," 条记录，所有档号均已验证"]})]})]})}),"idle"===S&&(0,a.jsx)("div",{className:"border rounded-lg p-4 bg-blue-50 dark:bg-blue-950/20",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(y.A,{className:"h-4 w-4 text-blue-600 mt-0.5"}),(0,a.jsxs)("div",{className:"text-sm text-blue-900 dark:text-blue-100",children:[(0,a.jsx)("div",{className:"font-medium mb-1",children:"CSV 文件要求："}),(0,a.jsxs)("ul",{className:"list-disc list-inside space-y-0.5 text-xs",children:[(0,a.jsx)("li",{children:'必须包含"档号"列（用于匹配档案）'}),(0,a.jsx)("li",{children:"档号不能为空或重复"}),(0,a.jsx)("li",{children:"档号必须在系统中已存在（由 PDF 入库创建）"}),(0,a.jsx)("li",{children:"可选列：全宗号、保管期限、年度、题名等"})]})]})]})})]})})})}function G(e){let{number:s,label:t,status:r}=e,l={pending:(0,a.jsx)("span",{className:"text-xs",children:s}),loading:(0,a.jsx)(b.A,{className:"h-3 w-3 animate-spin"}),success:(0,a.jsx)(M.A,{className:"h-3 w-3"}),error:(0,a.jsx)(y.A,{className:"h-3 w-3"})};return(0,a.jsxs)("div",{className:"flex items-center gap-1.5 px-3 py-1.5 rounded-full border ".concat({pending:"bg-gray-100 text-gray-500 border-gray-200",loading:"bg-blue-50 text-blue-600 border-blue-200",success:"bg-green-50 text-green-600 border-green-200",error:"bg-red-50 text-red-600 border-red-200"}[r]),children:[l[r],(0,a.jsx)("span",{className:"text-xs font-medium",children:t})]})}function Y(e){let{title:s,success:t,children:r}=e;return(0,a.jsxs)("div",{className:"border rounded-lg p-4 ".concat(t?"bg-green-50 dark:bg-green-950/20":"bg-red-50 dark:bg-red-950/20"),children:[(0,a.jsx)("div",{className:"font-medium mb-3 ".concat(t?"text-green-900 dark:text-green-100":"text-red-900 dark:text-red-100"),children:s}),r]})}function ee(e){let{importRecordId:s,onComplete:t}=e,[l,n]=(0,r.useState)(null),[i,c]=(0,r.useState)(!1),o=async()=>{if(s){c(!0);try{let e=await fetch("/api/import/csv/".concat(s),{credentials:"include"});if(!e.ok){let s=await e.text();throw console.error("[CSV Import Progress] Failed:",e.status,s),Error("获取导入进度失败 (".concat(e.status,")"))}let a=await e.json();n(a),"completed"===a.status&&(null==t||t(a))}catch(e){console.error("[CSV Import Progress] Failed to fetch:",e)}finally{c(!1)}}};if((0,r.useEffect)(()=>{if(!s){n(null);return}o();let e=setInterval(o,2e3);return()=>clearInterval(e)},[s]),!s)return(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"请先选择 CSV 文件并开始导入"})})});if(!l&&i)return(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)(b.A,{className:"h-8 w-8 animate-spin text-muted-foreground"})})})});if(!l)return(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"未找到导入记录"})})});let x=l.processed-l.failed,u=l&&0!==l.total?Math.round(l.processed/l.total*100):0;return(0,a.jsxs)(d.Zp,{children:[(0,a.jsx)(d.aR,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(j.A,{className:"h-5 w-5 text-green-600"}),(0,a.jsx)(d.ZB,{className:"text-lg",children:"CSV 导入进度"})]}),(e=>{switch(e){case"pending":return(0,a.jsx)(Z.E,{variant:"secondary",children:"等待中"});case"processing":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-blue-500",children:"处理中"});case"completed":return(0,a.jsx)(Z.E,{variant:"default",className:"bg-green-500",children:"已完成"});case"failed":return(0,a.jsx)(Z.E,{variant:"destructive",children:"失败"})}})(l.status)]})}),(0,a.jsxs)(d.Wu,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-lg",children:[(e=>{switch(e){case"pending":return(0,a.jsx)(b.A,{className:"h-5 w-5 text-gray-500"});case"processing":return(0,a.jsx)(b.A,{className:"h-5 w-5 text-blue-500 animate-spin"});case"completed":return(0,a.jsx)(M.A,{className:"h-5 w-5 text-green-500"});case"failed":return(0,a.jsx)(W.A,{className:"h-5 w-5 text-red-500"})}})(l.status),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-medium",children:l.fileName}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["开始时间: ",new Date(l.createdAt).toLocaleString()]})]})]}),"processing"===l.status&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"处理进度"}),(0,a.jsxs)("span",{className:"font-medium",children:[u,"%"]})]}),(0,a.jsx)($,{value:u,className:"h-2"}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["已处理: ",l.processed," / ",l.total," 条记录"]})]}),("completed"===l.status||"failed"===l.status)&&(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{className:"text-center p-3 bg-green-50 dark:bg-green-950/20 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:x}),(0,a.jsx)("div",{className:"text-sm text-green-700 dark:text-green-400",children:"成功更新"})]}),(0,a.jsxs)("div",{className:"text-center p-3 bg-red-50 dark:bg-red-950/20 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:l.failed}),(0,a.jsx)("div",{className:"text-sm text-red-700 dark:text-red-400",children:"更新失败"})]}),(0,a.jsxs)("div",{className:"text-center p-3 bg-muted rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold",children:l.total}),(0,a.jsx)("div",{className:"text-sm text-muted-foreground",children:"总记录数"})]})]}),l.failed>0&&l.errors&&l.errors.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm font-medium text-red-600",children:[(0,a.jsx)(y.A,{className:"h-4 w-4"}),"失败记录详情 (",l.errors.length,")"]}),(0,a.jsx)("div",{className:"border rounded-lg max-h-[400px] overflow-y-auto",children:(0,a.jsxs)(k.XI,{children:[(0,a.jsx)(k.A0,{children:(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nd,{className:"w-[100px]",children:"序号"}),(0,a.jsx)(k.nd,{children:"档号"}),(0,a.jsx)(k.nd,{children:"失败原因"})]})}),(0,a.jsx)(k.BF,{children:l.errors.map((e,s)=>(0,a.jsxs)(k.Hj,{children:[(0,a.jsx)(k.nA,{className:"text-muted-foreground",children:s+1}),(0,a.jsx)(k.nA,{className:"font-mono text-sm",children:e.archiveNo}),(0,a.jsx)(k.nA,{className:"text-red-600",children:e.reason})]},s))})]})})]}),"completed"===l.status&&(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 bg-green-50 dark:bg-green-950/20 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-green-700 dark:text-green-400",children:[(0,a.jsx)(M.A,{className:"h-5 w-5"}),(0,a.jsx)("span",{className:"font-medium",children:"导入完成"})]}),(0,a.jsxs)("div",{className:"text-sm text-green-600 dark:text-green-500",children:["成功 ",x," 条，失败 ",l.failed," 条"]})]})]})]})}let es=(0,F.createServerReference)("40bd998ea275e7fa48c2f8a4388ed97b1f8bf15ea8",F.callServer,void 0,F.findSourceMapURL,"startImportAction"),et=(0,F.createServerReference)("40d5af8518f0b47624c2037d24aad6c0589b59626b",F.callServer,void 0,F.findSourceMapURL,"uploadCsvAction"),ea=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB";function er(){let{data:e,status:s}=(0,l.wV)(),t=(0,n.useRouter)(),[o,x]=(0,r.useState)([]),[u,h]=(0,r.useState)(!1),[w,A]=(0,r.useState)(null),[k,S]=(0,r.useState)(!1),[C,F]=(0,r.useState)(null),[E,V]=(0,r.useState)("pdf-upload"),[_,R]=(0,r.useState)(!1),[I,B]=(0,r.useState)([]);if("unauthenticated"===s)return t.push("/login"),null;let D=async()=>{if(0===o.length){z.o.error("请先选择要入库的文件");return}h(!0);try{let e=o.some(e=>e.file),s=[];if(e)for(let e of o){if(!e.file){s.push({name:e.name,path:e.path,size:e.size});continue}let t=Date.now(),a=Math.random().toString(36).substring(2,15),r=e.name.replace(/[\/\\:*?"<>|]/g,"-"),l="".concat(t,"-").concat(a,"-").concat(r),n=Math.ceil(e.file.size/614400);for(let t=0;t<n;t++){let a=614400*t,r=Math.min(a+614400,e.file.size),i=e.file.slice(a,r),d=new FormData;d.append("chunk",i),d.append("fileName",l),d.append("chunkIndex",t.toString()),d.append("totalChunks",n.toString());let c=await fetch("/api/upload/chunk",{method:"POST",body:d,credentials:"include"});if(!c.ok)throw Error("分片上传失败 (".concat(c.status,")"));let o=await c.json();if(!o.success)throw Error(o.error||"分片上传失败");o.complete&&s.push({name:o.name,path:o.path,size:o.size})}}else s=o.map(e=>({name:e.name,path:e.path,size:e.size}));let t=await es(s);t.success?(z.o.success("已提交 ".concat(o.length," 个文件，正在后台处理...")),x([]),V("progress")):z.o.error(t.error||"启动入库失败")}catch(e){console.error("Import error:",e),z.o.error(e instanceof Error?e.message:"启动入库失败")}finally{h(!1)}},$=async()=>{if(!w){z.o.error("请先选择 CSV 文件");return}S(!0);try{let e=new FormData;e.append("file",w);let s=await et(e);s.success?(z.o.success(s.message||"CSV 导入已开始"),F(s.importRecordId),V("progress")):z.o.error(s.error||"CSV 导入失败")}catch(e){console.error("CSV import error:",e),z.o.error(e instanceof Error?e.message:"CSV 导入失败")}finally{S(!1)}};return(0,a.jsxs)("div",{className:"container mx-auto py-8 space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"档案入库"}),(0,a.jsx)("p",{className:"text-muted-foreground mt-2",children:"批量导入 PDF 文件或 CSV 信息表到档案管理系统"})]}),(0,a.jsxs)(m,{value:E,onValueChange:e=>V(e),children:[(0,a.jsxs)(p,{className:"grid w-full grid-cols-4",children:[(0,a.jsxs)(v,{value:"pdf-upload",children:[(0,a.jsx)(f.A,{className:"h-4 w-4 mr-2"}),"PDF入库"]}),(0,a.jsxs)(v,{value:"csv-upload",children:[(0,a.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"CSV导入"]}),(0,a.jsxs)(v,{value:"progress",children:[(0,a.jsx)(b.A,{className:"h-4 w-4 mr-2"}),"处理进度"]}),(0,a.jsxs)(v,{value:"history",children:[(0,a.jsx)(N.A,{className:"h-4 w-4 mr-2"}),"历史记录"]})]}),(0,a.jsxs)(g,{value:"pdf-upload",className:"space-y-4",children:[(0,a.jsx)(P,{onFilesSelected:e=>{x(e)},disabled:u,selectedFiles:o}),o.length>0&&(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"font-medium",children:["已选择 ",o.length," 个文件"]}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["总大小: ",ea(o.reduce((e,s)=>e+s.size,0))]})]}),(0,a.jsx)(i.$,{onClick:D,disabled:u,size:"lg",children:u?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.A,{className:"h-4 w-4 mr-2 animate-spin"}),"启动中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(f.A,{className:"h-4 w-4 mr-2"}),"开始入库"]})})]})})}),o.length>0&&(0,a.jsxs)(c.Fc,{children:[(0,a.jsx)(y.A,{className:"h-4 w-4"}),(0,a.jsx)(c.TN,{children:'入库过程中，文件将被重命名并存储到系统配置的目录中。您可以切换到"处理进度"标签页查看实时进度。'})]})]}),(0,a.jsxs)(g,{value:"csv-upload",className:"space-y-4",children:[(0,a.jsx)(Q,{onFileSelected:e=>{A(e||null),R(!1),B([])},onValidationComplete:e=>{e&&e.length>0&&(R(!0),B(e))},disabled:k}),w&&_&&(0,a.jsx)(d.Zp,{children:(0,a.jsx)(d.Wu,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"已选择文件"}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:[w.name," (",ea(w.size),")"]}),(0,a.jsxs)("p",{className:"text-xs text-green-600 mt-1",children:["✓ 已通过校验，",I.length," 条记录可导入"]})]}),(0,a.jsx)(i.$,{onClick:$,disabled:k,size:"lg",children:k?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.A,{className:"h-4 w-4 mr-2 animate-spin"}),"导入中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"开始导入"]})})]})})})]}),(0,a.jsxs)(g,{value:"progress",className:"space-y-4",children:[C&&(0,a.jsx)(ee,{importRecordId:C,onComplete:e=>{let s=e.processed-e.failed;z.o.success("CSV 导入完成：成功 ".concat(s," 条，失败 ").concat(e.failed," 条"))}}),(0,a.jsx)(J,{onComplete:e=>{z.o.success('文件 "'.concat(e.fileName,'" 入库完成'))},autoRefresh:!0,refreshInterval:2e3})]}),(0,a.jsx)(g,{value:"history",children:(0,a.jsx)(K,{autoRefresh:!0,refreshInterval:1e4})})]})]})}},9677:(e,s,t)=>{"use strict";t.d(s,{Fc:()=>i,TN:()=>d});var a=t(5155);t(2115);var r=t(1027),l=t(9602);let n=(0,r.F)("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function i(e){let{className:s,variant:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"alert",role:"alert",className:(0,l.cn)(n({variant:t}),s),...r})}function d(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"alert-description",className:(0,l.cn)("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",s),...t})}},9286:(e,s,t)=>{"use strict";t.d(s,{E:()=>d});var a=t(5155);t(2115);var r=t(2317),l=t(1027),n=t(9602);let i=(0,l.F)("inline-flex items-center justify-center rounded-full border border-transparent px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border-border text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",ghost:"[a&]:hover:bg-accent [a&]:hover:text-accent-foreground",link:"text-primary underline-offset-4 [a&]:hover:underline"}},defaultVariants:{variant:"default"}});function d(e){let{className:s,variant:t="default",asChild:l=!1,...d}=e,c=l?r.DX:"span";return(0,a.jsx)(c,{"data-slot":"badge","data-variant":t,className:(0,n.cn)(i({variant:t}),s),...d})}},4085:(e,s,t)=>{"use strict";t.d(s,{$:()=>d,r:()=>i});var a=t(5155);t(2115);var r=t(2317),l=t(1027),n=t(9602);let i=(0,l.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",xs:"h-6 gap-1 rounded-md px-2 text-xs has-[>svg]:px-1.5 [&_svg:not([class*='size-'])]:size-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9","icon-xs":"size-6 rounded-md [&_svg:not([class*='size-'])]:size-3","icon-sm":"size-8","icon-lg":"size-10"}},defaultVariants:{variant:"default",size:"default"}});function d(e){let{className:s,variant:t="default",size:l="default",asChild:d=!1,...c}=e,o=d?r.DX:"button";return(0,a.jsx)(o,{"data-slot":"button","data-variant":t,"data-size":l,className:(0,n.cn)(i({variant:t,size:l,className:s})),...c})}},5007:(e,s,t)=>{"use strict";t.d(s,{Wu:()=>d,ZB:()=>i,Zp:()=>l,aR:()=>n});var a=t(5155);t(2115);var r=t(9602);function l(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"card",className:(0,r.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",s),...t})}function n(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"card-header",className:(0,r.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",s),...t})}function i(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"card-title",className:(0,r.cn)("leading-none font-semibold",s),...t})}function d(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"card-content",className:(0,r.cn)("px-6",s),...t})}},2336:(e,s,t)=>{"use strict";t.d(s,{p:()=>l});var a=t(5155);t(2115);var r=t(9602);function l(e){let{className:s,type:t,...l}=e;return(0,a.jsx)("input",{type:t,"data-slot":"input",className:(0,r.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",s),...l})}},5785:(e,s,t)=>{"use strict";t.d(s,{J:()=>n});var a=t(5155);t(2115);var r=t(4352),l=t(9602);function n(e){let{className:s,...t}=e;return(0,a.jsx)(r.b,{"data-slot":"label",className:(0,l.cn)("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",s),...t})}},1453:(e,s,t)=>{"use strict";t.d(s,{d:()=>o});var a=t(5155),r=t(4085),l=t(2336),n=t(7661),i=t(3518),d=t(6967),c=t(7054);function o(e){let{currentPage:s,totalPages:t,total:o,pageSize:x,onPageChange:u}=e,m=Math.min(s*x,o),h=e=>{e>=1&&e<=t&&u(e)};return o<=x?null:(0,a.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,a.jsxs)("div",{className:"text-sm text-muted-foreground flex-1",children:["显示 ",(s-1)*x+1," - ",m," / 共 ",o," 条"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.$,{size:"sm",variant:"outline",disabled:1===s,onClick:()=>h(1),title:"首页",children:(0,a.jsx)(n.A,{className:"h-4 w-4"})}),(0,a.jsx)(r.$,{size:"sm",variant:"outline",disabled:1===s,onClick:()=>h(s-1),title:"上一页",children:(0,a.jsx)(i.A,{className:"h-4 w-4"})}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)("span",{className:"text-sm",children:["第",(0,a.jsx)(l.p,{type:"number",min:1,max:t,value:s,onChange:e=>{let s=parseInt(e.target.value);s>=1&&s<=t&&u(s)},className:"w-16 h-8 text-center"}),"/ ",t," 页"]})}),(0,a.jsx)(r.$,{size:"sm",variant:"outline",disabled:s===t,onClick:()=>h(s+1),title:"下一页",children:(0,a.jsx)(d.A,{className:"h-4 w-4"})}),(0,a.jsx)(r.$,{size:"sm",variant:"outline",disabled:s===t,onClick:()=>h(t),title:"尾页",children:(0,a.jsx)(c.A,{className:"h-4 w-4"})})]})]})}},745:(e,s,t)=>{"use strict";t.d(s,{bq:()=>x,eb:()=>m,gC:()=>u,l6:()=>c,yv:()=>o});var a=t(5155);t(2115);var r=t(5297),l=t(1719),n=t(8867),i=t(1902),d=t(9602);function c(e){let{...s}=e;return(0,a.jsx)(r.bL,{"data-slot":"select",...s})}function o(e){let{...s}=e;return(0,a.jsx)(r.WT,{"data-slot":"select-value",...s})}function x(e){let{className:s,size:t="default",children:n,...i}=e;return(0,a.jsxs)(r.l9,{"data-slot":"select-trigger","data-size":t,className:(0,d.cn)("border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...i,children:[n,(0,a.jsx)(r.In,{asChild:!0,children:(0,a.jsx)(l.A,{className:"size-4 opacity-50"})})]})}function u(e){let{className:s,children:t,position:l="item-aligned",align:n="center",...i}=e;return(0,a.jsx)(r.ZL,{children:(0,a.jsxs)(r.UC,{"data-slot":"select-content",className:(0,d.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md","popper"===l&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:l,align:n,...i,children:[(0,a.jsx)(h,{}),(0,a.jsx)(r.LM,{className:(0,d.cn)("p-1","popper"===l&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"),children:t}),(0,a.jsx)(p,{})]})})}function m(e){let{className:s,children:t,...l}=e;return(0,a.jsxs)(r.q7,{"data-slot":"select-item",className:(0,d.cn)("focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",s),...l,children:[(0,a.jsx)("span",{"data-slot":"select-item-indicator",className:"absolute right-2 flex size-3.5 items-center justify-center",children:(0,a.jsx)(r.VF,{children:(0,a.jsx)(n.A,{className:"size-4"})})}),(0,a.jsx)(r.p4,{children:t})]})}function h(e){let{className:s,...t}=e;return(0,a.jsx)(r.PP,{"data-slot":"select-scroll-up-button",className:(0,d.cn)("flex cursor-default items-center justify-center py-1",s),...t,children:(0,a.jsx)(i.A,{className:"size-4"})})}function p(e){let{className:s,...t}=e;return(0,a.jsx)(r.wn,{"data-slot":"select-scroll-down-button",className:(0,d.cn)("flex cursor-default items-center justify-center py-1",s),...t,children:(0,a.jsx)(l.A,{className:"size-4"})})}},2079:(e,s,t)=>{"use strict";t.d(s,{A0:()=>n,BF:()=>i,Hj:()=>d,XI:()=>l,nA:()=>o,nd:()=>c});var a=t(5155);t(2115);var r=t(9602);function l(e){let{className:s,...t}=e;return(0,a.jsx)("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:(0,a.jsx)("table",{"data-slot":"table",className:(0,r.cn)("w-full caption-bottom text-sm",s),...t})})}function n(e){let{className:s,...t}=e;return(0,a.jsx)("thead",{"data-slot":"table-header",className:(0,r.cn)("[&_tr]:border-b",s),...t})}function i(e){let{className:s,...t}=e;return(0,a.jsx)("tbody",{"data-slot":"table-body",className:(0,r.cn)("[&_tr:last-child]:border-0",s),...t})}function d(e){let{className:s,...t}=e;return(0,a.jsx)("tr",{"data-slot":"table-row",className:(0,r.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",s),...t})}function c(e){let{className:s,...t}=e;return(0,a.jsx)("th",{"data-slot":"table-head",className:(0,r.cn)("text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",s),...t})}function o(e){let{className:s,...t}=e;return(0,a.jsx)("td",{"data-slot":"table-cell",className:(0,r.cn)("p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",s),...t})}},9602:(e,s,t)=>{"use strict";t.d(s,{cn:()=>l});var a=t(3463),r=t(9795);function l(){for(var e=arguments.length,s=Array(e),t=0;t<e;t++)s[t]=arguments[t];return(0,r.QP)((0,a.$)(s))}}},e=>{var s=s=>e(e.s=s);e.O(0,[9406,2291,696,8348,814,5782,8441,1517,7358],()=>s(3399)),_N_E=e.O()}]);