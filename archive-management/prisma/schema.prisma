generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  username      String         @unique
  password      String
  role          String         @default("user")
  status        String         @default("enabled")
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  importRecords ImportRecord[]
  operationLogs OperationLog[]
}

model Archive {
  archiveID       String         @id @default(cuid())
  archiveNo       String         @unique
  fondsNo         String
  retentionPeriod String
  retentionCode   String
  year            String
  deptCode        String
  boxNo           String
  pieceNo         String
  title           String
  deptIssue       String
  responsible     String
  docNo           String
  date            String
  pageNo          String
  remark          String?
  fileUrl         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  importRecordId  String?
  importRecord    ImportRecord?  @relation(fields: [importRecordId], references: [id])
  operationLogs   OperationLog[]

  @@index([archiveNo])
  @@index([fondsNo])
  @@index([year])
  @@index([title])
  @@index([createdAt])
}

model ImportRecord {
  id        String    @id @default(cuid())
  fileName  String?
  type      String    @default("pdf") // "pdf" or "csv"
  total     Int
  processed Int       @default(0)
  failed    Int       @default(0)
  skipped   Int       @default(0) // Count of skipped items (e.g., duplicate archive numbers)
  status    String    @default("processing")
  errors    Json?     // Store detailed error information for CSV imports
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  archives  Archive[]
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
}

model License {
  id         String   @id @default(cuid())
  name       String   @default("未命名授权")
  deviceCode String   @unique
  authCode   String   @unique
  expireTime DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([deviceCode])
  @@index([expireTime])
}

model OperationLog {
  id          String   @id @default(cuid())
  operator    String   @default("system")
  operation   String   @default("unknown")
  target      String   @default("")
  ip          String   @default("")
  time        DateTime @default(now())
  archiveId   String?
  action      String?
  entityType  String?
  entityId    String?
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  userId      String?
  archive     Archive? @relation(fields: [archiveId], references: [archiveID])
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([operation])
  @@index([time])
  @@index([archiveId])
}

model SystemConfig {
  id          String          @id @default(cuid())
  configKey   String          @unique
  configValue String
  configType  String          @default("string")
  description String?
  group       String          @default("default")
  isSystem    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  history     ConfigHistory[]

  @@index([group])
  @@index([configKey])
}

model ConfigHistory {
  id        String       @id @default(cuid())
  configKey String
  oldValue  String
  newValue  String
  operator  String
  createdAt DateTime     @default(now())
  configId  String
  config    SystemConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configKey])
  @@index([createdAt])
  @@index([configId])
}
